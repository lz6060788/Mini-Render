å¤ªæ£’äº†ï¼è§£å†³äº†æ¸²æŸ“é—®é¢˜åï¼Œæˆ‘ä»¬çš„å¼•æ“å·²ç»æœ‰äº†â€œéª¨æ¶â€å’Œâ€œè¡€è‚‰â€ã€‚ç°åœ¨çš„ **Stage 3** å°±æ˜¯è¦ç»™å®ƒæ³¨å…¥â€œç¥ç»ç³»ç»Ÿâ€ï¼Œè®©å®ƒèƒ½æ„ŸçŸ¥ç”¨æˆ·çš„æ“ä½œã€‚

### ğŸ“… é¡¹ç›®è¿›åº¦å›é¡¾ä¸åç»­è§„åˆ’

æˆ‘ä»¬ç›®å‰å¤„äº Stage 3ã€‚

*   âœ… **Stage 1: åŸºç¡€æ¶æ„ (Math, Element, Circle)** - *å·²å®Œæˆ*
    *   å®ç°äº†çŸ©é˜µè¿ç®—ã€èŠ‚ç‚¹æ ‘ç»“æ„ã€åŸºç¡€å›¾å½¢ç±»ã€‚
*   âœ… **Stage 2: æ ¸å¿ƒæ¸²æŸ“ (Storage, Painter, Group)** - *å·²å®Œæˆ*
    *   å®ç°äº†åœºæ™¯å›¾ç®¡ç†ã€Canvas æ¸²æŸ“å¾ªç¯ã€å±‚çº§æ’åºã€‚
    *   *åˆšåˆšä¿®å¤äº†å±æ€§åŒæ­¥å’ŒçŸ©é˜µæ›´æ–°é¡ºåºçš„ Bugã€‚*
*   ğŸ‘‰ **Stage 3: äº¤äº’ç³»ç»Ÿ (Handler, Eventful, Picking)** - *å½“å‰ä»»åŠ¡*
    *   ç›®æ ‡ï¼šå®ç°é¼ æ ‡ç‚¹å‡»ã€æ‚¬åœæ£€æµ‹ã€‚
    *   æ ¸å¿ƒéš¾ç‚¹ï¼š**åæ ‡é€†å˜æ¢**ï¼ˆæŠŠé¼ æ ‡çš„å…¨å±€åæ ‡è½¬å›å›¾å½¢çš„å±€éƒ¨åæ ‡ï¼‰å’Œ **åŒ…å«åˆ¤æ–­**ï¼ˆç‚¹æ˜¯å¦åœ¨åœ†/æ–¹å—å†…ï¼‰ã€‚
*   â¬œ **Stage 4: åŠ¨ç”»ä¸è„çŸ©å½¢ (Animator, Optimization)** - *å¾…å®š*

---

### ğŸš€ Stage 3: å®ç°äº¤äº’ç³»ç»Ÿ (Handler)

è¦å®ç°äº¤äº’ï¼Œæˆ‘ä»¬éœ€è¦è§£å†³ä¸‰ä¸ªå±‚é¢çš„é—®é¢˜ï¼š
1.  **æ•°å­¦å±‚**ï¼šçŸ©é˜µæ±‚é€†ï¼ˆä¸ºäº†æŠŠé¼ æ ‡ç‚¹è½¬æ¢åˆ°å›¾å½¢å†…éƒ¨åæ ‡ç³»ï¼‰ã€‚
2.  **åŸºç±»å±‚**ï¼šäº‹ä»¶è®¢é˜…æœºåˆ¶ï¼ˆOn/Offï¼‰å’ŒåŒ…å«åˆ¤æ–­æ¥å£ï¼ˆContainï¼‰ã€‚
3.  **æ§åˆ¶å±‚**ï¼šç›‘å¬ DOM äº‹ä»¶å¹¶åˆ†å‘ç»™å›¾å½¢ã€‚

#### ç¬¬ä¸€æ­¥ï¼šæ•°å­¦å·¥å…·å‡çº§ (çŸ©é˜µæ±‚é€†)

æˆ‘ä»¬åœ¨ `src/utils/matrix.ts` ä¸­åªå®ç°äº†ä¹˜æ³•å’Œåˆæˆã€‚ä¸ºäº†åšç¢°æ’æ£€æµ‹ï¼Œæˆ‘ä»¬éœ€è¦**é€†çŸ©é˜µ**ã€‚
*ä¸ºä»€ä¹ˆï¼Ÿ* å› ä¸ºå›¾å½¢è¢«å¹³ç§»ã€æ—‹è½¬ã€ç¼©æ”¾äº†ã€‚åˆ¤æ–­ç‚¹ `(100, 100)` æ˜¯å¦åœ¨è¢«æ—‹è½¬äº† 30 åº¦çš„çŸ©å½¢é‡Œå¾ˆéš¾ï¼›ä½†æŠŠç‚¹é€†å‘æ—‹è½¬ 30 åº¦ï¼Œåˆ¤æ–­å®ƒæ˜¯å¦åœ¨æœªæ—‹è½¬çš„çŸ©å½¢é‡Œå¾ˆç®€å•ã€‚

åœ¨ `src/utils/matrix.ts` ä¸­è¿½åŠ ï¼š

```typescript
// src/utils/matrix.ts

/**
 * æ±‚é€†çŸ©é˜µ
 * out = invert(a)
 */
export function invert(out: MatrixArray, a: MatrixArray): MatrixArray {
    const aa = a[0], ac = a[2], atx = a[4];
    const ab = a[1], ad = a[3], aty = a[5];

    // è®¡ç®—è¡Œåˆ—å¼
    let det = aa * ad - ab * ac;
    if (!det) {
        // è¡Œåˆ—å¼ä¸º0ï¼Œæ— æ³•æ±‚é€†ï¼Œè¿”å› null æˆ– è®¾ä¸ºå•ä½çŸ©é˜µ
        return [1, 0, 0, 1, 0, 0] as any; // ç®€å•å¤„ç†
    }
    det = 1.0 / det;

    out[0] = ad * det;
    out[1] = -ab * det;
    out[2] = -ac * det;
    out[3] = aa * det;
    out[4] = (ac * aty - ad * atx) * det;
    out[5] = (ab * atx - aa * aty) * det;
    return out;
}
```

#### ç¬¬äºŒæ­¥ï¼šå®ç°äº‹ä»¶ä¸­å¿ƒ (Eventful)

æˆ‘ä»¬éœ€è¦ä¸€ä¸ªç±»æ¥ç®¡ç† `.on`, `.trigger`ã€‚

åˆ›å»º `src/core/Eventful.ts`ï¼š

```typescript
// src/core/Eventful.ts

type EventHandler = (...args: any[]) => void;

export class Eventful {
    private _handlers: { [event: string]: EventHandler[] } = {};

    on(event: string, handler: EventHandler): this {
        if (!this._handlers[event]) {
            this._handlers[event] = [];
        }
        this._handlers[event].push(handler);
        return this;
    }

    off(event?: string, handler?: EventHandler): this {
        // ç®€åŒ–å®ç°ï¼šæ¸…ç©ºæŒ‡å®šäº‹ä»¶æˆ–å…¨éƒ¨
        if (event && !handler) {
            this._handlers[event] = [];
        } else if (!event) {
            this._handlers = {};
        }
        // å®Œæ•´å®ç°è¿˜éœ€è¦å¤„ç†ç§»é™¤ç‰¹å®š handlerï¼Œè¿™é‡Œç•¥è¿‡
        return this;
    }

    trigger(event: string, ...args: any[]): this {
        const handlers = this._handlers[event];
        if (handlers) {
            handlers.forEach(h => h.apply(this, args));
        }
        return this;
    }
}
```

è®© `Element` ç»§æ‰¿ `Eventful`ã€‚
ä¿®æ”¹ `src/graphic/Element.ts`ï¼š

```typescript
import { Eventful } from '../core/Eventful';
// ...
export abstract class Element extends Eventful { 
    // ... 
}
```

#### ç¬¬ä¸‰æ­¥ï¼šå›¾å½¢æ‹¾å–é€»è¾‘ (Element & Shape)

æˆ‘ä»¬éœ€è¦åœ¨ `Displayable` ä¸­å®šä¹‰æ ‡å‡†ï¼Œå¹¶åœ¨ `Circle` ä¸­å®ç°å…·ä½“ç®—æ³•ã€‚

**1. ä¿®æ”¹ `src/graphic/Element.ts`**
å¢åŠ åæ ‡è½¬æ¢æ–¹æ³•ã€‚è¿™æ˜¯äº¤äº’çš„æ ¸å¿ƒã€‚

```typescript
// src/graphic/Element.ts

export abstract class Element extends Eventful {
    // ... åŸæœ‰ä»£ç  ...

    // è¾…åŠ©çŸ©é˜µï¼Œé¿å…é‡å¤åˆ›å»ºå¯¹è±¡ (GCä¼˜åŒ–)
    private static _invertMat: MatrixArray = matrix.create();

    /**
     * å°†å…¨å±€åæ ‡è½¬æ¢åˆ°å½“å‰å…ƒç´ çš„å±€éƒ¨åæ ‡ç³»
     * @param x å…¨å±€ x
     * @param y å…¨å±€ y
     * @return [localX, localY]
     */
    globalToLocal(x: number, y: number): Point {
        const m = this.globalTransform;
        // è®¡ç®—é€†çŸ©é˜µ
        // æ³¨æ„ï¼šè¿™é‡Œç”¨ç®€å•çš„é™æ€å˜é‡ç¼“å­˜é€†çŸ©é˜µï¼Œéçº¿ç¨‹å®‰å…¨ä½†JSæ˜¯å•çº¿ç¨‹æ‰€ä»¥OK
        const inv = Element._invertMat;
        matrix.invert(inv, m);

        // åº”ç”¨é€†å˜æ¢: x' = a*x + c*y + tx
        const lx = inv[0] * x + inv[2] * y + inv[4];
        const ly = inv[1] * x + inv[3] * y + inv[5];
        
        return [lx, ly];
    }
}
```

**2. ä¿®æ”¹ `src/graphic/Displayable.ts`**
å¢åŠ æŠ½è±¡æ–¹æ³• `contain`ã€‚

```typescript
// src/graphic/Displayable.ts

export abstract class Displayable extends Element {
    // ... åŸæœ‰ä»£ç  ...

    /**
     * åˆ¤æ–­ç‚¹æ˜¯å¦åœ¨å›¾å½¢å†…
     * @param x å…¨å±€ x
     * @param y å…¨å±€ y
     */
    contain(x: number, y: number): boolean {
        // 1. è½¬æ¢ä¸ºå±€éƒ¨åæ ‡
        const local = this.globalToLocal(x, y);
        // 2. è°ƒç”¨å…·ä½“å½¢çŠ¶çš„å‡ ä½•åˆ¤æ–­
        return this.containLocal(local[0], local[1]);
    }

    /**
     * å…·ä½“å½¢çŠ¶å®ç°è¿™ä¸ªæ–¹æ³•ï¼Œåˆ¤æ–­å±€éƒ¨åæ ‡æ˜¯å¦åœ¨è·¯å¾„å†…
     */
    abstract containLocal(x: number, y: number): boolean;
}
```

**3. ä¿®æ”¹ `src/graphic/shape/Circle.ts`**
å®ç°åœ†å½¢çš„å‡ ä½•åˆ¤æ–­ã€‚

```typescript
// src/graphic/shape/Circle.ts

export class Circle extends Displayable {
    // ... åŸæœ‰ä»£ç  ...

    containLocal(x: number, y: number): boolean {
        // åœ†å½¢åˆ¤æ–­å¾ˆç®€å•ï¼šç‚¹åˆ°åœ†å¿ƒçš„è·ç¦» < åŠå¾„
        // æ³¨æ„ï¼šè¿™é‡Œçš„ x,y å·²ç»æ˜¯ç»è¿‡é€†å˜æ¢çš„ï¼Œæ‰€ä»¥æ˜¯åœ¨åœ†æ²¡æœ‰è¢«æ—‹è½¬ç¼©æ”¾çš„åæ ‡ç³»ä¸‹
        // è€Œ this.shape.cx/cy ä¹Ÿæ˜¯åœ¨è¿™ä¸ªåæ ‡ç³»ä¸‹
        const d2 = Math.pow(x - this.shape.cx, 2) + Math.pow(y - this.shape.cy, 2);
        return d2 <= this.shape.r * this.shape.r;
    }
}
```

#### ç¬¬å››æ­¥ï¼šå®ç° Handler æ§åˆ¶å™¨

è¿™æ˜¯æœ€åä¸€å—æ‹¼å›¾ã€‚å®ƒç›‘å¬ DOM äº‹ä»¶ï¼Œæ‰¾åˆ°å›¾å½¢ï¼Œç„¶åç”±å›¾å½¢è§¦å‘äº‹ä»¶ã€‚

åˆ›å»º `src/handler/Handler.ts`ï¼š

```typescript
// src/handler/Handler.ts
import { Storage } from '../storage/Storage';
import { Painter } from '../painter/Painter';
import { Displayable } from '../graphic/Displayable';

export class Handler {
    storage: Storage;
    painter: Painter;
    dom: HTMLElement;

    constructor(storage: Storage, painter: Painter, dom: HTMLElement) {
        this.storage = storage;
        this.painter = painter;
        this.dom = dom;

        // åˆå§‹åŒ– DOM ç›‘å¬
        this._initDomEvents();
    }

    private _initDomEvents() {
        // ç®€å•çš„ç›‘å¬ click äº‹ä»¶ä½œä¸ºç¤ºä¾‹
        this.dom.addEventListener('click', (e) => {
            this._clickHandler(e);
        });
        
        // å®é™… ZRender è¿˜æœ‰ mousedown, mouseup, mousemove ç­‰å¤æ‚é€»è¾‘
    }

    private _clickHandler(e: MouseEvent) {
        // 1. è·å–ç›¸å¯¹äº Canvas çš„åæ ‡
        // getBoundingClientRect åŒ…å«äº†é¡µé¢æ»šåŠ¨å’Œè¾¹æ¡†
        const rect = this.dom.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // 2. å¯»æ‰¾è¢«ç‚¹å‡»çš„å›¾å½¢
        const target = this._findHover(x, y);

        if (target) {
            // 3. è§¦å‘å›¾å½¢äº‹ä»¶
            console.log('Clicked shape:', target.id);
            target.trigger('click', { target: target, event: e });
        } else {
            console.log('Clicked empty space');
        }
    }

    private _findHover(x: number, y: number): Displayable | null {
        const list = this.storage.getDisplayList();
        
        // æ ¸å¿ƒï¼šé€†åºéå†ï¼
        // å› ä¸º displayList æ˜¯æŒ‰æ¸²æŸ“é¡ºåºæ’çš„ï¼ˆåé¢çš„ç›–åœ¨å‰é¢ï¼‰ï¼Œ
        // æ‰€ä»¥æˆ‘ä»¬æ£€æµ‹ç‚¹å‡»æ—¶ï¼Œè¦ä»æœ€ä¸Šé¢ï¼ˆæ•°ç»„æœ«å°¾ï¼‰å¼€å§‹æŸ¥ã€‚
        for (let i = list.length - 1; i >= 0; i--) {
            const el = list[i];
            
            // å¿½ç•¥ä¸å¯è§æˆ–ä¸å“åº”é¼ æ ‡çš„å…ƒç´ 
            if (el.invisible) continue; // å¯ä»¥å†åŠ  ignoreMouse ç­‰æ ‡å¿—

            // ç¢°æ’æ£€æµ‹
            if (el.contain(x, y)) {
                return el;
            }
        }
        return null;
    }
}
```

#### ç¬¬äº”æ­¥ï¼šé›†æˆåˆ° ZRender

ä¿®æ”¹ `src/core/ZRender.ts`ï¼Œåˆå§‹åŒ– Handlerã€‚

```typescript
// src/core/ZRender.ts
import { Handler } from '../handler/Handler';

export class ZRender {
    storage: Storage;
    painter: Painter;
    handler: Handler; // æ–°å¢

    constructor(dom: HTMLElement) {
        this.storage = new Storage();
        this.painter = new Painter(dom, this.storage);
        // åˆå§‹åŒ–äº¤äº’ç³»ç»Ÿ
        this.handler = new Handler(this.storage, this.painter, dom);
    }
    // ...
}
```

---

### ğŸ® æœ€ç»ˆæµ‹è¯• (Stage 3 Demo)

ç°åœ¨æˆ‘ä»¬ä¿®æ”¹ `index.ts` æ¥æµ‹è¯•ç‚¹å‡»äº‹ä»¶ã€‚æˆ‘ä»¬åˆ©ç”¨ `Eventful` çš„èƒ½åŠ›ã€‚

```typescript
// index.ts
import { init } from './core/ZRender';
import { Group } from './graphic/Group';
import { Circle } from './graphic/shape/Circle';

const zr = init(document.getElementById('main')!);

const group = new Group({ position: [200, 200] });

// ä¸€ä¸ªçº¢è‰²çš„åœ†
const circle = new Circle({
    shape: { r: 50 },
    style: { fill: '#F00' }
});

// ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼
circle.on('click', () => {
    console.log('Circle Clicked!');
    // ç‚¹å‡»å˜è‰²
    if (circle.style.fill === '#F00') {
        circle.style.fill = '#00F'; // å˜è“
    } else {
        circle.style.fill = '#F00'; // å˜çº¢
    }
    zr.refresh(); // è®°å¾—æ‰‹åŠ¨åˆ·æ–°
});

group.add(circle);
zr.add(group);

// åŠ¨ç”»ï¼šè®©å®ƒæ—‹è½¬ï¼Œæµ‹è¯•æ—‹è½¬åçš„ç‚¹å‡»æ£€æµ‹æ˜¯å¦å‡†ç¡®
let angle = 0;
function loop() {
    angle += 0.01;
    group.rotation = angle;
    // æ‰‹åŠ¨æ›´æ–° Group å±æ€§ï¼ŒPainter ä¼šåœ¨ refresh æ—¶è®¡ç®—çŸ©é˜µ
    
    // å¦‚æœæƒ³è¦ç‚¹å‡»ç”Ÿæ•ˆï¼Œä¸éœ€è¦ä¸€ç›´ refreshï¼Œä½†ä¸ºäº†çœ‹åŠ¨ç”»ï¼š
    zr.refresh();
    requestAnimationFrame(loop);
}
loop();
```

### é¢„æœŸç»“æœ

1.  å±å¹•ä¸Šæœ‰ä¸€ä¸ªæ—‹è½¬çš„åœ†ã€‚
2.  å½“ä½ ç‚¹å‡»åœ†çš„å†…éƒ¨æ—¶ï¼Œæ§åˆ¶å°è¾“å‡º "Circle Clicked!"ï¼Œå¹¶ä¸”åœ†é¢œè‰²åœ¨çº¢è“ä¹‹é—´åˆ‡æ¢ã€‚
3.  **å…³é”®ç‚¹**ï¼šå³ä½¿åœ†æ—‹è½¬åˆ°äº†å¥‡æ€ªçš„è§’åº¦ï¼Œæˆ–è€…è¢« Group ç¼©æ”¾äº†ï¼Œåªè¦ä½ çš„é¼ æ ‡ç‚¹åœ¨è§†è§‰ä¸Šçš„åœ†å†…ï¼Œäº‹ä»¶å°±åº”è¯¥è§¦å‘ã€‚è¿™å°±æ˜¯ `invert` é€†çŸ©é˜µçš„ä½œç”¨ã€‚

å¦‚æœè¿™ä¸€æ­¥æˆåŠŸäº†ï¼Œæ­å–œä½ ï¼ä½ å·²ç»å®Œæˆäº†ä¸€ä¸ªéº»é›€è™½å°äº”è„ä¿±å…¨çš„ 2D ç»˜å›¾å¼•æ“ï¼ˆMini-ZRï¼‰ã€‚å®ƒå…·å¤‡äº†**MVC ç»“æ„**ã€**åœºæ™¯å›¾**ã€**æ¸²æŸ“ç®¡çº¿**å’Œ**äº¤äº’ç³»ç»Ÿ**ã€‚